{% extends "base.html" %}
{% block title %}Analytics - JobFlow{% endblock %}
{% block nav_analytics %}active{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-900">Analytics</h1>
    <p class="text-sm text-gray-500 mt-1">Insights and trends from your job applications</p>
</div>

<!-- KPI Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="stat-card-minimal">
        <p class="text-sm text-gray-600">Success Rate</p>
        <p class="text-3xl font-bold text-gray-900">{{ stats.success_rate|round(1) }}%</p>
    </div>
    <div class="stat-card-minimal">
        <p class="text-sm text-gray-600">Total Sent</p>
        <p class="text-3xl font-bold text-gray-900">{{ stats.sent }}</p>
    </div>
    <div class="stat-card-minimal">
        <p class="text-sm text-gray-600">Total Follow-ups</p>
        <p class="text-3xl font-bold text-gray-900">{{ stats.total_followups }}</p>
    </div>
    <div class="stat-card-minimal">
        <p class="text-sm text-gray-600">Bounce Rate</p>
        <p class="text-3xl font-bold text-gray-900">{{ (stats.bounced / stats.total_applications * 100)|round(1) if stats.total_applications > 0 else 0 }}%</p>
    </div>
</div>

<!-- Main Charts -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Applications Over Time -->
    <div class="chart-card">
        <div class="chart-header">
            <h3 class="chart-title">Applications Over Time</h3>
        </div>
        <div class="chart-body">
            <canvas id="timelineChart" height="250"></canvas>
        </div>
    </div>
    
    <!-- Status Distribution -->
    <div class="chart-card">
        <div class="chart-header">
            <h3 class="chart-title">Status Distribution</h3>
        </div>
        <div class="chart-body">
            <canvas id="statusChart" height="250"></canvas>
        </div>
    </div>
</div>

<!-- Company Heatmap & Follow-up Analysis -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Top Companies -->
    <div class="chart-card">
        <div class="chart-header">
            <h3 class="chart-title">Top Companies (Applications Sent)</h3>
        </div>
        <div class="chart-body">
            <canvas id="companyChart" height="300"></canvas>
        </div>
    </div>
    
    <!-- Follow-up Effectiveness -->
    <div class="chart-card">
        <div class="chart-header">
            <h3 class="chart-title">Follow-up Distribution</h3>
        </div>
        <div class="chart-body">
            <canvas id="followupChart" height="300"></canvas>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Timeline Chart
new Chart(document.getElementById('timelineChart'), {
    type: 'line',
    data: {
        labels: {{ timeline.labels | tojson }},
        datasets: [{
            label: 'Applications Sent',
            data: {{ timeline.data | tojson }},
            borderColor: 'rgb(59, 130, 246)',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
    }
});

// Status Distribution
const statusData = {{ status_distribution | tojson }};
new Chart(document.getElementById('statusChart'), {
    type: 'doughnut',
    data: {
        labels: Object.keys(statusData),
        datasets: [{
            data: Object.values(statusData),
            backgroundColor: [
                'rgb(34, 197, 94)',  // Sent
                'rgb(251, 191, 36)', // Pending
                'rgb(239, 68, 68)',  // Bounced
                'rgb(156, 163, 175)' // Other
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false
    }
});

// Company Heatmap
const companies = {{ company_heatmap | tojson }};
new Chart(document.getElementById('companyChart'), {
    type: 'bar',
    data: {
        labels: companies.map(c => c.company),
        datasets: [{
            label: 'Applications',
            data: companies.map(c => c.count),
            backgroundColor: 'rgb(168, 85, 247)'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
    }
});

// Follow-up Distribution
const followupDist = {{ followup_data.distribution | tojson }};
new Chart(document.getElementById('followupChart'), {
    type: 'bar',
    data: {
        labels: Object.keys(followupDist).map(k => k + ' follow-ups'),
        datasets: [{
            label: 'Applications',
            data: Object.values(followupDist),
            backgroundColor: 'rgb(59, 130, 246)'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
    }
});
</script>
{% endblock %}