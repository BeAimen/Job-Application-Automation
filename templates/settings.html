{% extends "base.html" %}
{% block title %}Settings - JobFlow{% endblock %}
{% block nav_settings %}active{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-900">Settings</h1>
    <p class="text-sm text-gray-500 mt-1">Manage your preferences and configuration</p>
</div>

<div class="max-w-4xl">
    <form id="settingsForm">
        <!-- General Settings -->
        <div class="bg-white rounded-lg border border-gray-200 shadow-sm mb-6">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">General Settings</h2>
            </div>
            <div class="p-6 space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Default Language</label>
                    <select name="default_language" class="form-input max-w-xs">
                        <option value="both" {% if settings.default_language == 'both' %}selected{% endif %}>Both (EN + FR)</option>
                        <option value="en" {% if settings.default_language == 'en' %}selected{% endif %}>English</option>
                        <option value="fr" {% if settings.default_language == 'fr' %}selected{% endif %}>French</option>
                    </select>
                    <p class="mt-1 text-sm text-gray-500">This will be the default language when opening Send Application</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Follow-up Interval (days)</label>
                    <input type="number" name="followup_days" value="{{ settings.followup_days }}" class="form-input max-w-xs">
                    <p class="mt-1 text-sm text-gray-500">Days to wait before sending follow-up emails</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Timezone</label>
                    <select name="timezone" class="form-input max-w-xs">
                        <option value="UTC" {% if settings.timezone == 'UTC' %}selected{% endif %}>UTC (GMT+0)</option>
                        <option value="Europe/Paris" {% if settings.timezone == 'Europe/Paris' %}selected{% endif %}>Central European Time (GMT+1)</option>
                        <option value="America/New_York" {% if settings.timezone == 'America/New_York' %}selected{% endif %}>Eastern Time (GMT-5)</option>
                        <option value="America/Los_Angeles" {% if settings.timezone == 'America/Los_Angeles' %}selected{% endif %}>Pacific Time (GMT-8)</option>
                        <option value="Asia/Tokyo" {% if settings.timezone == 'Asia/Tokyo' %}selected{% endif %}>Japan Time (GMT+9)</option>
                    </select>
                    <p class="mt-1 text-sm text-gray-500">Used for timestamps and scheduling</p>
                </div>
            </div>
        </div>

        <!-- Email Settings -->
        <div class="bg-white rounded-lg border border-gray-200 shadow-sm mb-6">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">Email Settings</h2>
            </div>
            <div class="p-6 space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Delay Between Emails (seconds)</label>
                    <input type="number" name="email_delay" value="{{ settings.email_delay }}" min="1" max="10" class="form-input max-w-xs">
                    <p class="mt-1 text-sm text-gray-500">
                        <i class="fas fa-info-circle text-blue-500"></i>
                        Recommended: 2-5 seconds to avoid Gmail rate limits
                    </p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Max Retry Attempts</label>
                    <input type="number" name="max_retries" value="{{ settings.max_retries }}" min="1" max="5" class="form-input max-w-xs">
                    <p class="mt-1 text-sm text-gray-500">Number of times to retry failed emails</p>
                </div>

                <div class="flex items-center">
                    <input type="checkbox" name="auto_followup" id="autoFollowup"
                           {% if settings.auto_followup %}checked{% endif %}
                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <label for="autoFollowup" class="ml-2 text-sm text-gray-700">
                        Enable automatic follow-ups (requires scheduled task)
                    </label>
                </div>
            </div>
        </div>

        <!-- Save Settings Button -->
        <div class="flex justify-end mb-6">
            <button type="submit" class="btn-primary">
                <i class="fas fa-save mr-2"></i> Save Settings
            </button>
        </div>
    </form>

    <!-- Data Management -->
    <div class="bg-white rounded-lg border border-gray-200 shadow-sm">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">Data Management</h2>
        </div>
        <div class="p-6 space-y-4">
            <button onclick="exportData()" class="btn-secondary w-full justify-center">
                <i class="fas fa-download mr-2"></i> Export All Data (CSV)
            </button>

            <button onclick="confirmClearData()" class="btn-secondary w-full justify-center text-red-600 border-red-300 hover:bg-red-50">
                <i class="fas fa-trash mr-2"></i> Clear All Data
            </button>
        </div>
    </div>
</div>

<script>
// Save settings
document.getElementById('settingsForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(e.target);
    const submitButton = e.target.querySelector('button[type="submit"]');

    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';

    try {
        const response = await fetch('/api/settings/save', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (response.ok && data.success) {
            showToast('Settings saved successfully! Reload the page to apply changes.', 'success');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showToast('Failed to save settings: ' + (data.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showToast('Network error: ' + error.message, 'error');
    } finally {
        submitButton.disabled = false;
        submitButton.innerHTML = '<i class="fas fa-save mr-2"></i> Save Settings';
    }
});

// Export data as CSV
async function exportData() {
    try {
        const response = await fetch('/api/settings/export', {
            method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
            // Create download
            const blob = new Blob([data.data], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = data.filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showToast('Data exported successfully', 'success');
        } else {
            showToast('Failed to export data: ' + data.error, 'error');
        }
    } catch (error) {
        showToast('Network error: ' + error.message, 'error');
    }
}

// Confirm clear data
function confirmClearData() {
    if (confirm('⚠️ WARNING: This will permanently delete ALL application data. This action cannot be undone. Are you absolutely sure?')) {
        if (confirm('This is your final confirmation. Type "DELETE" in the next prompt to proceed.')) {
            const confirmation = prompt('Type "DELETE" to confirm:');
            if (confirmation === 'DELETE') {
                showToast('Data clear disabled for safety. Manually delete from Google Sheets.', 'warning');
            } else {
                showToast('Data clear cancelled', 'info');
            }
        }
    }
}
</script>
{% endblock %}