{% extends "base.html" %}
{% block title %}Companies - JobFlow{% endblock %}
{% block nav_companies %}active{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <!-- Page Header -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Companies Database</h1>
            <p class="text-sm text-gray-500 mt-1">Manage your company contacts and information</p>
        </div>
        <button onclick="showAddCompanyModal()" class="btn-primary">
            <i class="fas fa-plus mr-2"></i> Add Company
        </button>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="stat-card-minimal">
            <p class="text-sm text-gray-600">Total Companies</p>
            <p id="totalCompanies" class="text-3xl font-bold text-gray-900">{{ companies|length }}</p>
        </div>
        <div class="stat-card-minimal">
            <p class="text-sm text-gray-600">With Email</p>
            <p id="withEmailCount" class="text-3xl font-bold text-green-600">{{ companies|selectattr('email')|list|length }}</p>
        </div>
        <div class="stat-card-minimal">
            <p class="text-sm text-gray-600">Without Email</p>
            <p id="withoutEmailCount" class="text-3xl font-bold text-yellow-600">{{ (companies|length) - (companies|selectattr('email')|list|length) }}</p>
        </div>
        <div class="stat-card-minimal">
            <p class="text-sm text-gray-600">Added This Month</p>
            <p id="addedThisMonth" class="text-3xl font-bold text-blue-600">{{ recent_count }}</p>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white shadow rounded-lg p-4 mb-6">
        <div class="flex flex-wrap gap-4 items-end">
            <div class="flex-1 min-w-[200px]">
                <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                <input type="text" id="searchInput" placeholder="Search by name, type, location..."
                       class="form-input" onkeyup="filterCompanies()">
            </div>

            <div class="min-w-[150px]">
                <label class="block text-sm font-medium text-gray-700 mb-1">Filter by Type</label>
                <select id="typeFilter" class="form-input" onchange="filterCompanies()">
                    <option value="">All Types</option>
                    <option value="oil & gas">Oil & Gas</option>
                    <option value="petrochemical">Petrochemical</option>
                    <option value="power & energy">Power & Energy</option>
                    <option value="manufacturing / industrial plants">Manufacturing / Industrial Plants</option>
                    <option value="food processing / food industry">Food Processing / Food Industry</option>
                    <option value="consumer goods">Consumer Goods</option>
                </select>
            </div>

            <div class="min-w-[150px]">
                <label class="block text-sm font-medium text-gray-700 mb-1">Email Status</label>
                <select id="emailFilter" class="form-input" onchange="filterCompanies()">
                    <option value="">All</option>
                    <option value="with">With Email</option>
                    <option value="without">Without Email</option>
                </select>
            </div>

            <button onclick="clearFilters()" class="btn-secondary">
                <i class="fas fa-times mr-1"></i> Clear
            </button>
        </div>
    </div>

    <!-- Companies Table -->
    <div class="bg-white shadow rounded-lg overflow-hidden">
        <div id="noCompaniesPlaceholder" class="text-center py-12" style="{{ 'display:none;' if companies else '' }}">
            <i class="fas fa-building text-gray-400 text-5xl mb-4"></i>
            <p class="text-gray-500 text-lg">No companies yet</p>
            <button onclick="showAddCompanyModal()" class="mt-4 text-blue-600 hover:text-blue-800 font-medium">
                <i class="fas fa-plus mr-1"></i> Add your first company
            </button>
        </div>

        <div id="companiesTableWrapper" class="overflow-x-auto" style="{{ '' if companies else 'display:none;' }}">
            <table class="min-w-full divide-y divide-gray-200" id="companiesTable">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Company</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Contact</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Location</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Added</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="companiesTbody">
                    {% for company in companies %}
                    <tr class="hover:bg-gray-50 company-row"
                        data-id="{{ company.id }}"
                        data-name="{{ company.name|lower }}"
                        data-type="{{ company.type|lower if company.type else '' }}"
                        data-location="{{ company.location|lower if company.location else '' }}"
                        data-has-email="{{ 'yes' if company.email else 'no' }}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10 bg-gradient-to-br from-blue-400 to-blue-600 rounded-lg flex items-center justify-center">
                                    <span class="text-white font-bold text-lg">{{ company.name[0]|upper }}</span>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">{{ company.name }}</div>
                                    {% if company.website %}
                                    <a href="{{ company.website }}" target="_blank" class="text-xs text-blue-600 hover:text-blue-800">
                                        <i class="fas fa-external-link-alt mr-1"></i>Website
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if company.type %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                {{ company.type }}
                            </span>
                            {% else %}
                            <span class="text-gray-400 text-sm">—</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">
                                {% if company.email %}
                                {% set emails = company.email.split(',') %}
                                <div class="flex items-center mb-1">
                                    <i class="fas fa-envelope text-green-500 mr-2"></i>
                                    <a href="mailto:{{ emails[0].strip() }}" class="text-blue-600 hover:text-blue-800">
                                        {{ emails[0].strip() }}
                                    </a>
                                </div>
                                {% if emails|length > 1 %}
                                <div class="text-xs text-gray-500 ml-6">+{{ emails|length - 1 }} more</div>
                                {% endif %}
                                {% else %}
                                <span class="text-gray-400 text-xs">No email</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {{ company.location or '—' }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ company.added_date[:10] if company.added_date else 'N/A' }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex space-x-2">
                                <a href="/companies/{{ company.id }}"
   class="text-blue-600 hover:text-blue-900 p-2 rounded hover:bg-blue-50"
   title="View Details">
    <i class="fas fa-eye"></i>
</a>

                                </button>
                                <button onclick="editCompany('{{ company.id }}')"
                                        class="text-green-600 hover:text-green-900 p-2 rounded hover:bg-green-50"
                                        title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteCompany('{{ company.id }}','{{ company.name|escape }}')"
                                        class="text-red-600 hover:text-red-900 p-2 rounded hover:bg-red-50"
                                        title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add/Edit Modal -->
<div id="companyModal" class="modal hidden" role="dialog" aria-modal="true">
    <div id="companyModalOverlay" class="fixed inset-0 bg-black bg-opacity-50 transition-opacity"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-2xl">
                <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-purple-50">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-bold text-gray-900" id="modalTitle">
                            <i class="fas fa-building text-blue-600 mr-2"></i>
                            Add New Company
                        </h3>
                        <button type="button" onclick="closeCompanyModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>

                <form id="companyForm" class="p-6 space-y-4">
                    <input type="hidden" id="companyId" name="id">

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Company Name <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="companyName" name="name" required
                               placeholder="e.g., Tesla, Microsoft, Sonatrach"
                               class="form-input">
                        <p id="duplicateWarning" class="hidden mt-1 text-sm text-red-600">
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            A company with this name already exists
                        </p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Type</label>
                            <select id="companyType" name="type" class="form-input" required>
                                <option value="Oil & Gas" selected>Oil & Gas</option>
                                <option value="Petrochemical">Petrochemical</option>
                                <option value="Power & Energy">Power & Energy</option>
                                <option value="Manufacturing / Industrial Plants">Manufacturing / Industrial Plants</option>
                                <option value="Food Processing / Food Industry">Food Processing / Food Industry</option>
                                <option value="Consumer Goods">Consumer Goods</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                            <input type="text" id="companyLocation" name="location"
                                   placeholder="City, Country"
                                   class="form-input">
                        </div>
                    </div>

                    <div class="border-t pt-4">
                        <h4 class="font-semibold text-gray-900 mb-3">Contact Information</h4>

                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-envelope text-gray-400 mr-1"></i> Email Addresses
                                </label>
                                <div id="emailChipsContainer" class="flex flex-wrap gap-2 p-2 border border-gray-300 rounded-lg min-h-[42px] bg-gray-50 mb-2">
                                    <!-- Email chips will be added here -->
                                </div>
                                <div class="flex gap-2">
                                    <input type="text" id="emailInput"
                                           placeholder="Enter email and press Enter"
                                           class="form-input flex-1">
                                    <button type="button" onclick="addEmailChip()" class="btn-secondary">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <input type="hidden" id="companyEmail" name="email">
                                <p class="mt-1 text-xs text-gray-500">
                                    <i class="fas fa-info-circle text-blue-500"></i>
                                    Add multiple emails - press Enter or click + after each
                                </p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-phone text-gray-400 mr-1"></i> Phone
                                </label>
                                <input type="tel" id="companyPhone" name="phone"
                                       placeholder="+1-234-567-8900"
                                       class="form-input">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-globe text-gray-400 mr-1"></i> Website
                                </label>
                                <input type="text" id="companyWebsite" name="website"
                                       inputmode="url"
                                       placeholder="company.com"
                                       class="form-input">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-link text-gray-400 mr-1"></i> Reference
                                </label>
                                <input type="text" id="companyReference" name="reference"
                                       placeholder="Job reference, requisition ID, or source"
                                       class="form-input">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-dollar-sign text-gray-400 mr-1"></i> Salary Range
                                </label>
                                <input type="text" id="companySalaryRange" name="salary_range"
                                       placeholder="e.g. 80,000 – 120,000 DZD / month"
                                       class="form-input">
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-sticky-note text-gray-400 mr-1"></i> Notes
                        </label>
                        <textarea id="companyNotes" name="notes" rows="3"
                                  placeholder="Additional information, contacts, etc."
                                  class="form-input"></textarea>
                    </div>
                </form>

                <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3">
                    <button type="button" onclick="closeCompanyModal()" class="btn-secondary">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                    <button type="button" onclick="submitCompany()" id="submitBtn" class="btn-primary">
                        <i class="fas fa-save mr-2"></i>Save Company
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View Details Modal -->
<div id="viewModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity" onclick="closeViewModal()"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-3xl">
                <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-blue-500 to-purple-600">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-bold text-white">
                            <i class="fas fa-building mr-2"></i>
                            <span id="viewCompanyName"></span>
                        </h3>
                        <button type="button" onclick="closeViewModal()" class="text-white hover:text-gray-200">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>

                <div id="viewContent" class="p-6">
                    <!-- Content loaded dynamically -->
                </div>

                <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3">
                    <button type="button" onclick="closeViewModal()" class="btn-secondary">
                        <i class="fas fa-times mr-2"></i>Close
                    </button>
                    <button type="button" onclick="editFromView()" id="editFromViewBtn" class="btn-primary">
                        <i class="fas fa-edit mr-2"></i>Edit
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.email-chip {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.75rem;
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 500;
}

.email-chip button {
    margin-left: 0.5rem;
    color: white;
    opacity: 0.8;
    transition: opacity 0.2s;
}

.email-chip button:hover {
    opacity: 1;
}

.spinner {
    border: 2px solid #f3f3f3;
    border-top: 2px solid #3b82f6;
    border-radius: 50%;
    width: 16px;
    height: 16px;
    animation: spin 1s linear infinite;
    display: inline-block;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

{% endblock %}

{% block scripts %}
<script>
// Global state
let existingCompanies = {{ companies|map(attribute='name')|map('lower')|list|tojson }};
let currentViewId = null;
let emailChips = [];

// Email chip management
function addEmailChip() {
    const input = document.getElementById('emailInput');
    const email = input.value.trim();

    if (!email) return;

    // Basic email validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showToast('Invalid email format', 'error');
        return;
    }

    // Check for duplicates
    if (emailChips.includes(email)) {
        showToast('Email already added', 'warning');
        return;
    }

    emailChips.push(email);
    renderEmailChips();
    input.value = '';
    updateHiddenEmailField();
}

function removeEmailChip(email) {
    emailChips = emailChips.filter(e => e !== email);
    renderEmailChips();
    updateHiddenEmailField();
}

function renderEmailChips() {
    const container = document.getElementById('emailChipsContainer');
    container.innerHTML = emailChips.map(email => `
        <div class="email-chip">
            ${escapeHtml(email)}
            <button type="button" onclick="removeEmailChip('${escapeAttr(email)}')" class="hover:scale-110">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `).join('');
}

function updateHiddenEmailField() {
    document.getElementById('companyEmail').value = emailChips.join(', ');
}

// Enter key handler for email input
document.addEventListener('DOMContentLoaded', function() {
    const emailInput = document.getElementById('emailInput');
    if (emailInput) {
        emailInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addEmailChip();
            }
        });
    }

    // Duplicate name checker
    const nameInput = document.getElementById('companyName');
    if (nameInput) {
        nameInput.addEventListener('input', function() {
            checkDuplicate(this.value);
        });
    }
});

function checkDuplicate(name) {
    const warning = document.getElementById('duplicateWarning');
    const submitBtn = document.getElementById('submitBtn');
    const currentId = document.getElementById('companyId').value;

    const nameLower = name.trim().toLowerCase();

    // Check if exists (but allow if editing the same company)
    const isDuplicate = existingCompanies.includes(nameLower) && !currentId;

    if (isDuplicate) {
        warning.classList.remove('hidden');
        submitBtn.disabled = true;
        submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
    } else {
        warning.classList.add('hidden');
        submitBtn.disabled = false;
        submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }
}

function showAddCompanyModal() {
    document.getElementById('companyForm').reset();
    document.getElementById('companyId').value = '';
    document.getElementById('modalTitle').innerHTML = '<i class="fas fa-building text-blue-600 mr-2"></i>Add New Company';
    document.getElementById('duplicateWarning').classList.add('hidden');
    emailChips = [];
    renderEmailChips();
    document.getElementById('companyModal').classList.remove('hidden');
    document.getElementById('companyName').focus();
}

function closeCompanyModal() {
    document.getElementById('companyModal').classList.add('hidden');
    document.getElementById('companyForm').reset();
    emailChips = [];
}

async function editCompany(id) {
    try {
        const response = await fetch(`/api/companies/${id}`);
        const data = await response.json();

        if (data.success && data.company) {
            const company = data.company;

            document.getElementById('companyId').value = company.id;
            document.getElementById('companyName').value = company.name;
            document.getElementById('companyType').value = company.type || 'Oil & Gas';
            document.getElementById('companyLocation').value = company.location || '';
            document.getElementById('companyPhone').value = company.phone || '';
            document.getElementById('companyWebsite').value = company.website || '';
            document.getElementById('companyReference').value = company.reference || '';
            document.getElementById('companySalaryRange').value = company.salary_range || '';
            document.getElementById('companyNotes').value = company.notes || '';

            // Load emails into chips
            emailChips = company.email ? company.email.split(',').map(e => e.trim()).filter(e => e) : [];
            renderEmailChips();
            updateHiddenEmailField();

            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit text-blue-600 mr-2"></i>Edit Company';
            document.getElementById('companyModal').classList.remove('hidden');
        } else {
            showToast('Failed to load company details', 'error');
        }
    } catch (error) {
        showToast('Error loading company: ' + error.message, 'error');
    }
}

async function viewCompany(id) {
    currentViewId = id;

    try {
        const response = await fetch(`/api/companies/${id}`);
        const data = await response.json();

        if (data.success && data.company) {
            const company = data.company;

            document.getElementById('viewCompanyName').textContent = company.name;

            const emails = company.email ? company.email.split(',').map(e => e.trim()).filter(e => e) : [];

            document.getElementById('viewContent').innerHTML = `
                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Type</p>
                            <p class="mt-1 text-base text-gray-900">${escapeHtml(company.type || '—')}</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Location</p>
                            <p class="mt-1 text-base text-gray-900">${escapeHtml(company.location || '—')}</p>
                        </div>
                    </div>

                    <div class="border-t pt-4">
                        <h4 class="font-semibold text-gray-900 mb-3">Contact Information</h4>

                        ${emails.length > 0 ? `
                            <div class="mb-4">
                                <p class="text-sm font-medium text-gray-500 mb-2">Email Addresses</p>
                                <div class="space-y-2">
                                    ${emails.map((email, i) => `
                                        <div class="flex items-center p-2 bg-blue-50 rounded">
                                            <i class="fas fa-envelope text-blue-500 mr-2"></i>
                                            <a href="mailto:${escapeHtml(email)}" class="text-blue-600 hover:text-blue-800">
                                                ${escapeHtml(email)}
                                            </a>
                                            ${i === 0 ? '<span class="ml-2 text-xs bg-blue-200 text-blue-800 px-2 py-0.5 rounded">Primary</span>' : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : '<p class="text-gray-400 text-sm mb-4">No email addresses</p>'}

                        ${company.phone ? `
                            <div class="mb-4">
                                <p class="text-sm font-medium text-gray-500">Phone</p>
                                <p class="mt-1 text-base text-gray-900">
                                    <i class="fas fa-phone text-gray-400 mr-2"></i>
                                    <a href="tel:${escapeHtml(company.phone)}">${escapeHtml(company.phone)}</a>
                                </p>
                            </div>
                        ` : ''}

                        ${company.website ? `
                            <div class="mb-4">
                                <p class="text-sm font-medium text-gray-500">Website</p>
                                <p class="mt-1 text-base text-gray-900">
                                    <i class="fas fa-globe text-gray-400 mr-2"></i>
                                    <a href="${escapeHtml(company.website)}" target="_blank" class="text-blue-600 hover:text-blue-800">
                                        ${escapeHtml(company.website)} <i class="fas fa-external-link-alt text-xs"></i>
                                    </a>
                                </p>
                            </div>
                        ` : ''}

                        ${company.reference ? `
                            <div class="mb-4">
                                <p class="text-sm font-medium text-gray-500">Reference</p>
                                <p class="mt-1 text-base text-gray-900">
                                    <i class="fas fa-link text-gray-400 mr-2"></i>
                                    ${escapeHtml(company.reference)}
                                </p>
                            </div>
                        ` : ''}

                        ${company.salary_range ? `
                            <div class="mb-4">
                                <p class="text-sm font-medium text-gray-500">Salary Range</p>
                                <p class="mt-1 text-base text-gray-900">
                                    <i class="fas fa-dollar-sign text-gray-400 mr-2"></i>
                                    ${escapeHtml(company.salary_range)}
                                </p>
                            </div>
                        ` : ''}
                    </div>

                    ${company.notes ? `
                        <div class="border-t pt-4">
                            <p class="text-sm font-medium text-gray-500 mb-2">Notes</p>
                            <div class="bg-yellow-50 border border-yellow-200 rounded p-3 text-sm text-gray-700">
                                ${escapeHtml(company.notes)}
                            </div>
                        </div>
                    ` : ''}

                    <div class="border-t pt-4">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <p class="text-gray-500">Added</p>
                                <p class="text-gray-900">${company.added_date ? company.added_date.slice(0, 10) : 'N/A'}</p>
                            </div>
                            <div>
                                <p class="text-gray-500">Last Updated</p>
                                <p class="text-gray-900">${company.last_updated ? company.last_updated.slice(0, 10) : 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('viewModal').classList.remove('hidden');
        } else {
            showToast('Failed to load company details', 'error');
        }
    } catch (error) {
        showToast('Error loading company: ' + error.message, 'error');
    }
}

function closeViewModal() {
    document.getElementById('viewModal').classList.add('hidden');
    currentViewId = null;
}

function editFromView() {
    closeViewModal();
    if (currentViewId) {
        editCompany(currentViewId);
    }
}

async function submitCompany() {
    const form = document.getElementById('companyForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const btn = document.getElementById('submitBtn');
    const orig = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner mr-2"></span>Saving...';

    const data = new FormData(form);
    const companyId = document.getElementById('companyId').value;
    const url = companyId ? `/api/companies/${encodeURIComponent(companyId)}` : '/api/companies';
    const method = companyId ? 'PUT' : 'POST';

    try {
        const res = await fetch(url, { method, body: data });
        const json = await res.json();

        if (json && json.success) {
            closeCompanyModal();

            if (companyId) {
                // Update existing row
                showToast('Company updated!', 'success');
                // Reload to refresh - simpler for updates
                setTimeout(() => window.location.reload(), 500);
            } else {
                // Add new company dynamically
                showToast('Company added!', 'success');

                // Add to existingCompanies for duplicate checking
                existingCompanies.push(json.company.name.toLowerCase());

                // Update stats
                const totalEl = document.getElementById('totalCompanies');
                const currentTotal = parseInt(totalEl.textContent);
                totalEl.textContent = currentTotal + 1;

                if (json.company.email) {
                    const withEmailEl = document.getElementById('withEmailCount');
                    withEmailEl.textContent = parseInt(withEmailEl.textContent) + 1;
                } else {
                    const withoutEmailEl = document.getElementById('withoutEmailCount');
                    withoutEmailEl.textContent = parseInt(withoutEmailEl.textContent) + 1;
                }

                // Check if this is the first company
                const tbody = document.getElementById('companiesTbody');
                const placeholder = document.getElementById('noCompaniesPlaceholder');

                if (placeholder && !placeholder.classList.contains('hidden')) {
                    // First company - hide placeholder and show table
                    placeholder.style.display = 'none';
                    document.getElementById('companiesTableWrapper').style.display = '';
                }

                // Add new row to table
                addCompanyRow(json.company);
            }
        } else {
            throw new Error(json.error || 'Save failed');
        }
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = orig;
    }
}

function addCompanyRow(company) {
    const tbody = document.getElementById('companiesTbody');
    if (!tbody) return;

    // Parse emails
    const emails = company.email ? company.email.split(',') : [];
    const firstEmail = emails.length > 0 ? emails[0].trim() : null;

    // Create new row
    const row = document.createElement('tr');
    row.className = 'hover:bg-gray-50 company-row';
    row.setAttribute('data-id', company.id);
    row.setAttribute('data-name', (company.name || '').toLowerCase());
    row.setAttribute('data-type', (company.type || '').toLowerCase());
    row.setAttribute('data-location', (company.location || '').toLowerCase());
    row.setAttribute('data-has-email', company.email ? 'yes' : 'no');

    row.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
                <div class="flex-shrink-0 h-10 w-10 bg-gradient-to-br from-blue-400 to-blue-600 rounded-lg flex items-center justify-center">
                    <span class="text-white font-bold text-lg">${escapeHtml(company.name[0].toUpperCase())}</span>
                </div>
                <div class="ml-4">
                    <div class="text-sm font-medium text-gray-900">${escapeHtml(company.name)}</div>
                    ${company.website ? `
                    <a href="${escapeHtml(company.website)}" target="_blank" class="text-xs text-blue-600 hover:text-blue-800">
                        <i class="fas fa-external-link-alt mr-1"></i>Website
                    </a>
                    ` : ''}
                </div>
            </div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
            ${company.type ? `
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                ${escapeHtml(company.type)}
            </span>
            ` : '<span class="text-gray-400 text-sm">—</span>'}
        </td>
        <td class="px-6 py-4">
            <div class="text-sm text-gray-900">
                ${firstEmail ? `
                <div class="flex items-center mb-1">
                    <i class="fas fa-envelope text-green-500 mr-2"></i>
                    <a href="mailto:${escapeHtml(firstEmail)}" class="text-blue-600 hover:text-blue-800">
                        ${escapeHtml(firstEmail)}
                    </a>
                </div>
                ${emails.length > 1 ? `<div class="text-xs text-gray-500 ml-6">+${emails.length - 1} more</div>` : ''}
                ` : '<span class="text-gray-400 text-xs">No email</span>'}
            </div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
            ${company.location ? escapeHtml(company.location) : '—'}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${company.added_date ? company.added_date.slice(0, 10) : 'N/A'}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
            <div class="flex space-x-2">
                <a href="/companies/${escapeHtml(company.id)}"
                   class="text-blue-600 hover:text-blue-900 p-2 rounded hover:bg-blue-50"
                   title="View Details">
                    <i class="fas fa-eye"></i>
                </a>
                <button onclick="editCompany('${escapeAttr(company.id)}')"
                        class="text-green-600 hover:text-green-900 p-2 rounded hover:bg-green-50"
                        title="Edit">
                    <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteCompany('${escapeAttr(company.id)}','${escapeAttr(company.name)}')"
                        class="text-red-600 hover:text-red-900 p-2 rounded hover:bg-red-50"
                        title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </td>
    `;

    // Add to top of table with animation
    row.style.opacity = '0';
    row.style.transform = 'translateY(-10px)';
    tbody.insertBefore(row, tbody.firstChild);

    // Animate in
    setTimeout(() => {
        row.style.transition = 'all 0.3s ease-out';
        row.style.opacity = '1';
        row.style.transform = 'translateY(0)';
    }, 10);
}

async function deleteCompany(id, name) {
    if (!confirm(`Are you sure you want to delete "${name}"? This action cannot be undone.`)) return;

    // Find the row and add spinner
    const row = document.querySelector(`.company-row[data-id="${id}"]`);
    if (row) {
        const actionsCell = row.querySelector('td:last-child');
        actionsCell.innerHTML = '<span class="spinner"></span>';
    }

    try {
        const res = await fetch('/api/companies/' + encodeURIComponent(id), { method: 'DELETE' });
        const json = await res.json();

        if (json && json.success) {
            if (row) row.remove();

            // Update stats
            const totalEl = document.getElementById('totalCompanies');
            totalEl.textContent = parseInt(totalEl.textContent) - 1;

            // Check if table is empty
            const tbody = document.getElementById('companiesTbody');
            if (!tbody || tbody.children.length === 0) {
                document.getElementById('companiesTableWrapper').style.display = 'none';
                document.getElementById('noCompaniesPlaceholder').style.display = '';
            }

            showToast('Company deleted', 'success');
        } else {
            throw new Error(json.error || 'Delete failed');
        }
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
        // Reload on error to restore UI
        setTimeout(() => window.location.reload(), 1000);
    }
}

function filterCompanies() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const typeFilter = document.getElementById('typeFilter').value.toLowerCase();
    const emailFilter = document.getElementById('emailFilter').value;

    const rows = document.querySelectorAll('.company-row');
    rows.forEach(row => {
        const name = row.dataset.name || '';
        const type = row.dataset.type || '';
        const location = row.dataset.location || '';
        const hasEmail = row.dataset.hasEmail || 'no';

        let show = true;
        if (searchTerm && !name.includes(searchTerm) && !type.includes(searchTerm) && !location.includes(searchTerm)) show = false;
        if (typeFilter && type !== typeFilter) show = false;
        if (emailFilter === 'with' && hasEmail !== 'yes') show = false;
        if (emailFilter === 'without' && hasEmail !== 'no') show = false;

        row.style.display = show ? '' : 'none';
    });
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('typeFilter').value = '';
    document.getElementById('emailFilter').value = '';
    filterCompanies();
}

function escapeHtml(s) {
    if (!s && s !== 0) return '';
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]));
}

function escapeAttr(s) {
    if (!s && s !== 0) return '';
    return String(s).replace(/'/g, "\\'").replace(/"/g, '\\"');
}

// Close modals on Escape
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        if (!document.getElementById('companyModal').classList.contains('hidden')) closeCompanyModal();
        if (!document.getElementById('viewModal').classList.contains('hidden')) closeViewModal();
    }
});
</script>
{% endblock %}
