{% extends "base.html" %}
{% block title %}Follow-ups - JobFlow{% endblock %}
{% block nav_followups %}active{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Follow-ups</h1>

        <!-- Language Toggle -->
        <div class="lang-toggle">
            <a href="/followups?lang=en"
               class="lang-toggle-btn {% if current_lang == 'en' %}active-en{% endif %}">
                <i class="fas fa-flag-usa mr-1"></i> English
            </a>
            <a href="/followups?lang=fr"
               class="lang-toggle-btn {% if current_lang == 'fr' %}active-fr{% endif %}">
                <i class="fas fa-flag mr-1"></i> French
            </a>
            <a href="/followups?lang=both"
               class="lang-toggle-btn {% if current_lang == 'both' %}active-both{% endif %}">
                <i class="fas fa-globe mr-1"></i> Both
            </a>
        </div>
    </div>

    <!-- Action Bar -->
    <div class="bg-white shadow rounded-lg p-6 mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-lg font-semibold text-gray-900">Process Due Follow-ups</h2>
                <p class="text-sm text-gray-500 mt-1">
                    <span class="font-bold text-blue-600">{{ due_applications|length }}</span> application(s) need follow-up
                </p>
            </div>

            <div class="flex space-x-3">
                <button onclick="processFollowups(true)" class="btn-secondary">
                    <i class="fas fa-eye mr-1"></i> Dry Run (Preview)
                </button>
                <button onclick="processFollowups(false)" class="btn-primary">
                    <i class="fas fa-paper-plane mr-1"></i> Send Follow-ups
                </button>
            </div>
        </div>
    </div>

    <!-- Results Display -->
    <div id="results" class="hidden mb-6"></div>

    <!-- Due Applications Table -->
    <div class="bg-white shadow rounded-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-purple-50">
            <h3 class="text-lg font-medium text-gray-900">
                <i class="fas fa-clock text-yellow-500 mr-2"></i>
                Applications Due for Follow-up
            </h3>
        </div>

        {% if due_applications %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Language</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Company</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Position</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Follow-ups</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Due Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">CV</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for app in due_applications %}
                    <tr class="{% if app.language == 'en' %}lang-row-en hover:bg-blue-50{% else %}lang-row-fr hover:bg-purple-50{% endif %} transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="lang-badge lang-badge-{{ app.language }} lang-icon-{{ app.language }}">
                                {{ app.language.upper() }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">{{ app.company }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">{{ app.email }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">{{ app.position }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                {{ app.followups }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ app.next_followup_date[:10] if app.next_followup_date else 'N/A' }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">
                                {% if app.cv %}
                                <i class="fas fa-file-pdf text-red-500 mr-1"></i> {{ app.cv }}
                                {% else %}
                                <span class="text-red-500">Missing</span>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-12">
            <i class="fas fa-check-circle text-green-400 text-5xl mb-4"></i>
            <p class="text-gray-500 text-lg">All caught up!</p>
            <p class="text-gray-400 text-sm mt-2">No follow-ups are due at this time</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
async function processFollowups(dryRun) {
    const resultsDiv = document.getElementById('results');
    const buttons = document.querySelectorAll('button');

    // Disable buttons
    buttons.forEach(btn => btn.disabled = true);

    // Show loading
    resultsDiv.classList.remove('hidden');
    resultsDiv.innerHTML = `
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex items-center">
                <i class="fas fa-spinner fa-spin text-blue-600 mr-3 text-xl"></i>
                <div>
                    <div class="font-medium text-blue-800">Processing follow-ups...</div>
                    <div class="text-sm text-blue-700 mt-1">This may take a few moments</div>
                </div>
            </div>
        </div>
    `;

    try {
        const formData = new FormData();
        formData.append('language', '{{ current_lang }}');
        formData.append('dry_run', dryRun);

        const response = await fetch('/followups/process', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (response.ok) {
            displayResults(data.stats, dryRun);

            // Reload page after successful send (not dry run)
            if (!dryRun) {
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            }
        } else {
            showError(data.detail || 'Failed to process follow-ups');
        }
    } catch (error) {
        showError('Network error: ' + error.message);
    } finally {
        // Re-enable buttons
        buttons.forEach(btn => btn.disabled = false);
    }
}

function displayResults(stats, dryRun) {
    const resultsDiv = document.getElementById('results');

    let html = `
        <div class="bg-white shadow rounded-lg p-6">
            <div class="flex items-start mb-4">
                <i class="fas fa-chart-bar text-blue-600 text-2xl mr-3"></i>
                <div class="flex-1">
                    <h3 class="text-lg font-medium text-gray-900">
                        ${dryRun ? 'Preview Results (Dry Run)' : 'Follow-up Results'}
                    </h3>
                    ${dryRun ? '<p class="text-sm text-gray-500 mt-1">No emails were actually sent</p>' : ''}
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-check-circle text-green-600 text-2xl mr-3"></i>
                        <div>
                            <div class="text-2xl font-bold text-green-900">${stats.sent}</div>
                            <div class="text-sm text-green-700">${dryRun ? 'Would be sent' : 'Sent'}</div>
                        </div>
                    </div>
                </div>

                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-circle text-yellow-600 text-2xl mr-3"></i>
                        <div>
                            <div class="text-2xl font-bold text-yellow-900">${stats.skipped}</div>
                            <div class="text-sm text-yellow-700">Skipped</div>
                        </div>
                    </div>
                </div>

                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-times-circle text-red-600 text-2xl mr-3"></i>
                        <div>
                            <div class="text-2xl font-bold text-red-900">${stats.failed}</div>
                            <div class="text-sm text-red-700">Failed</div>
                        </div>
                    </div>
                </div>
            </div>
    `;

    if (stats.errors && stats.errors.length > 0) {
        html += `
            <div class="border-t pt-4">
                <h4 class="font-medium text-gray-900 mb-2">Errors:</h4>
                <div class="space-y-2">
        `;

        stats.errors.forEach(error => {
            html += `
                <div class="flex items-start text-sm bg-red-50 p-3 rounded">
                    <i class="fas fa-exclamation-triangle text-red-500 mt-0.5 mr-2"></i>
                    <div>
                        <span class="font-medium">${error.email}:</span>
                        <span class="text-gray-600">${error.error}</span>
                    </div>
                </div>
            `;
        });

        html += `
                </div>
            </div>
        `;
    }

    html += '</div>';

    resultsDiv.innerHTML = html;
    resultsDiv.scrollIntoView({ behavior: 'smooth' });
}

function showError(message) {
    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = `
        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
            <div class="flex items-start">
                <i class="fas fa-exclamation-circle text-red-600 text-xl mr-3 mt-0.5"></i>
                <div class="flex-1">
                    <div class="font-medium text-red-800">Error</div>
                    <div class="text-sm text-red-700 mt-1">${message}</div>
                </div>
            </div>
        </div>
    `;
}
</script>
{% endblock %}