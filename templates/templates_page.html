{% extends "base.html" %}
{% block title %}Templates - JobFlow{% endblock %}
{% block nav_templates %}active{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold text-gray-900">Email Templates</h1>
        <p class="text-sm text-gray-500 mt-1">Create and manage your application templates</p>
    </div>
    <button onclick="showNewTemplateModal()" class="btn-primary">
        <i class="fas fa-plus mr-2"></i> New Template
    </button>
</div>

<!-- Template Categories -->
<div class="space-y-6">
    <!-- Application Templates -->
    <div class="bg-white rounded-lg border border-gray-200 shadow-sm">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-paper-plane text-blue-500 mr-2"></i>
                Application Templates
            </h2>
        </div>
        <div id="applicationTemplates" class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Templates will be rendered here -->
        </div>
    </div>

    <!-- Follow-up Templates -->
    <div class="bg-white rounded-lg border border-gray-200 shadow-sm">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-redo text-green-500 mr-2"></i>
                Follow-up Templates
            </h2>
        </div>
        <div id="followupTemplates" class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Templates will be rendered here -->
        </div>
    </div>
</div>

<!-- Template Editor Modal -->
<div id="templateModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-3xl transform transition-all">
                <!-- Modal Header -->
                <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-purple-50">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-bold text-gray-900 flex items-center">
                            <i class="fas fa-edit text-blue-600 mr-3"></i>
                            <span id="modalTitle">Create New Template</span>
                        </h3>
                        <button onclick="closeTemplateModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>

                <!-- Modal Body -->
                <form id="templateForm" class="p-6 space-y-6 max-h-[70vh] overflow-y-auto">
                    <input type="hidden" id="templateCategory" name="category">
                    <input type="hidden" id="templateId" name="id">

                    <!-- Category Selection -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">
                            <i class="fas fa-tag mr-2 text-blue-500"></i>Template Type
                        </label>
                        <div class="grid grid-cols-2 gap-4">
                            <button type="button" onclick="selectCategory('application')"
                                    id="categoryApplication"
                                    class="category-btn group relative p-5 border-2 border-gray-200 rounded-xl hover:border-blue-500 hover:shadow-lg transition-all duration-200 bg-white">
                                <div class="flex items-center justify-center mb-2">
                                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center group-hover:bg-blue-500 transition-colors">
                                        <i class="fas fa-paper-plane text-2xl text-blue-500 group-hover:text-white transition-colors"></i>
                                    </div>
                                </div>
                                <span class="font-semibold text-gray-700 group-hover:text-blue-600">Application</span>
                                <p class="text-xs text-gray-500 mt-1">Initial outreach email</p>
                            </button>
                            <button type="button" onclick="selectCategory('followup')"
                                    id="categoryFollowup"
                                    class="category-btn group relative p-5 border-2 border-gray-200 rounded-xl hover:border-green-500 hover:shadow-lg transition-all duration-200 bg-white">
                                <div class="flex items-center justify-center mb-2">
                                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center group-hover:bg-green-500 transition-colors">
                                        <i class="fas fa-redo text-2xl text-green-500 group-hover:text-white transition-colors"></i>
                                    </div>
                                </div>
                                <span class="font-semibold text-gray-700 group-hover:text-green-600">Follow-up</span>
                                <p class="text-xs text-gray-500 mt-1">Reminder email</p>
                            </button>
                        </div>
                    </div>

                    <!-- Template Name -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-font mr-2 text-purple-500"></i>Template Name
                        </label>
                        <input type="text" id="templateName" name="name" required
                               placeholder="e.g., Professional Application - Tech Industry"
                               class="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:bg-white focus:ring-2 focus:ring-blue-200 transition-all outline-none">
                    </div>

                    <!-- Language -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">
                            <i class="fas fa-language mr-2 text-green-500"></i>Language
                        </label>
                        <div class="grid grid-cols-2 gap-4">
                            <label class="relative cursor-pointer group">
                                <input type="radio" name="language" value="en" id="langEn" required class="peer sr-only">
                                <div class="flex items-center p-4 bg-gray-50 border-2 border-gray-200 rounded-xl peer-checked:border-blue-500 peer-checked:bg-blue-50 peer-checked:shadow-md transition-all duration-200">
                                    <div class="flex-shrink-0 mr-3">
                                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center peer-checked:bg-blue-500">
                                            <i class="fas fa-flag-usa text-xl text-blue-500 peer-checked:text-white"></i>
                                        </div>
                                    </div>
                                    <div>
                                        <p class="font-semibold text-gray-900">English</p>
                                        <p class="text-xs text-gray-500">US/UK format</p>
                                    </div>
                                </div>
                            </label>
                            <label class="relative cursor-pointer group">
                                <input type="radio" name="language" value="fr" id="langFr" required class="peer sr-only">
                                <div class="flex items-center p-4 bg-gray-50 border-2 border-gray-200 rounded-xl peer-checked:border-purple-500 peer-checked:bg-purple-50 peer-checked:shadow-md transition-all duration-200">
                                    <div class="flex-shrink-0 mr-3">
                                        <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center peer-checked:bg-purple-500">
                                            <i class="fas fa-flag text-xl text-purple-500 peer-checked:text-white"></i>
                                        </div>
                                    </div>
                                    <div>
                                        <p class="font-semibold text-gray-900">French</p>
                                        <p class="text-xs text-gray-500">FR format</p>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Email Body -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-envelope mr-2 text-yellow-500"></i>Email Body
                        </label>
                        <div class="relative">
                            <textarea id="templateBody" name="body" rows="12" required
                                      placeholder="Dear Hiring Manager,&#10;&#10;I am writing to express my interest in the [Position] position at [Company]...&#10;&#10;You can use placeholders:&#10;- [Company] for company name&#10;- [Position] for position title"
                                      class="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:bg-white focus:ring-2 focus:ring-blue-200 transition-all outline-none font-mono text-sm"></textarea>
                            <div class="absolute bottom-3 right-3 text-xs text-gray-400" id="charCount">0 characters</div>
                        </div>
                        <div class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <p class="text-sm text-blue-800 flex items-start">
                                <i class="fas fa-info-circle text-blue-500 mr-2 mt-0.5"></i>
                                <span>
                                    Use placeholders:
                                    <code class="bg-blue-100 px-2 py-1 rounded text-blue-900 font-semibold">[Company]</code> and
                                    <code class="bg-blue-100 px-2 py-1 rounded text-blue-900 font-semibold">[Position]</code>
                                </span>
                            </p>
                        </div>
                    </div>
                </form>

                <!-- Modal Footer -->
                <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3 rounded-b-xl">
                    <button type="button" onclick="closeTemplateModal()" class="btn-secondary">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                    <button type="button" onclick="submitTemplate()" id="submitBtn" class="btn-primary">
                        <i class="fas fa-save mr-2"></i>Save Template
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-md transform transition-all">
                <!-- Warning Header -->
                <div class="px-6 py-5 border-b border-red-200 bg-gradient-to-r from-red-50 to-red-100">
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0 w-12 h-12 bg-red-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-red-900">Delete Template</h3>
                            <p class="text-sm text-red-700 mt-1">This action cannot be undone</p>
                        </div>
                    </div>
                </div>

                <!-- Modal Body -->
                <div class="p-6">
                    <div class="mb-4">
                        <p class="text-gray-700 mb-2">You are about to delete:</p>
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-file-alt text-gray-400 text-2xl"></i>
                                <div>
                                    <p class="font-semibold text-gray-900" id="deleteTemplateName">Template Name</p>
                                    <span id="deleteTemplateLang" class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-700 mt-1">
                                        <i class="fas fa-flag-usa mr-1"></i>EN
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                        <div class="flex items-start space-x-2">
                            <i class="fas fa-info-circle text-yellow-600 mt-0.5"></i>
                            <div class="text-sm text-yellow-800">
                                <p class="font-semibold mb-1">Before you delete:</p>
                                <ul class="list-disc list-inside space-y-1">
                                    <li>This template will be permanently removed</li>
                                    <li>Any references to this template will be lost</li>
                                    <li>This action cannot be undone</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-start space-x-2 text-sm text-gray-600">
                        <input type="checkbox" id="deleteConfirmCheck" class="mt-1 rounded border-gray-300 text-red-600 focus:ring-red-500">
                        <label for="deleteConfirmCheck" class="cursor-pointer">
                            I understand that this action is permanent and cannot be reversed
                        </label>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3 rounded-b-xl">
                    <button type="button" onclick="closeDeleteModal()" class="btn-secondary">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                    <button type="button" onclick="confirmDelete()" id="deleteConfirmBtn" disabled
                            class="px-4 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 focus:ring-2 focus:ring-red-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                        <i class="fas fa-trash mr-2"></i>Delete Template
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let templatesData = {{ templates | tojson }};
let selectedCategory = 'application';
let isEditMode = false;
let pendingDelete = { category: null, id: null };

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    renderTemplates();

    // Character counter
    const bodyInput = document.getElementById('templateBody');
    if (bodyInput) {
        bodyInput.addEventListener('input', updateCharCount);
    }

    // Delete confirmation checkbox
    const deleteCheck = document.getElementById('deleteConfirmCheck');
    if (deleteCheck) {
        deleteCheck.addEventListener('change', function() {
            document.getElementById('deleteConfirmBtn').disabled = !this.checked;
        });
    }
});

function updateCharCount() {
    const body = document.getElementById('templateBody').value;
    const count = body.length;
    document.getElementById('charCount').textContent = `${count} characters`;
}

function renderTemplates() {
    renderCategoryTemplates('application');
    renderCategoryTemplates('followup');
}

function renderCategoryTemplates(category) {
    const container = document.getElementById(category === 'application' ? 'applicationTemplates' : 'followupTemplates');
    const templates = templatesData[category] || {};

    if (Object.keys(templates).length === 0) {
        container.innerHTML = `
            <div class="col-span-full text-center py-12">
                <i class="fas fa-inbox text-gray-300 text-5xl mb-4"></i>
                <p class="text-gray-500">No templates yet</p>
                <button onclick="showNewTemplateModal(); selectCategory('${category}')" class="mt-4 text-blue-600 hover:text-blue-700 font-medium">
                    <i class="fas fa-plus mr-1"></i> Create your first template
                </button>
            </div>
        `;
        return;
    }

    container.innerHTML = Object.entries(templates).map(([id, template]) => {
        const isDefault = template.is_default || false;

        // Check if template can be deleted
        const sameLanguageTemplates = Object.values(templates).filter(t => t.language === template.language);
        const canDelete = sameLanguageTemplates.length > 1 && !isDefault;

        return `
        <div class="template-card group bg-white border-2 ${isDefault ? (template.language === 'en' ? 'border-blue-500 bg-blue-50' : 'border-purple-500 bg-purple-50') : 'border-gray-200'} rounded-xl p-5 hover:border-${template.language === 'en' ? 'blue' : 'purple'}-500 hover:shadow-lg transition-all duration-200 relative">
            ${isDefault ? `
                <div class="absolute top-3 right-3 bg-gradient-to-r ${template.language === 'en' ? 'from-blue-500 to-blue-600' : 'from-purple-500 to-purple-600'} text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg flex items-center">
                    <i class="fas fa-star mr-1"></i>DEFAULT
                </div>
            ` : ''}
            <div class="flex items-start justify-between mb-3 ${isDefault ? 'pr-24' : ''}">
                <div class="flex-1">
                    <h3 class="font-bold text-gray-900 mb-2 flex items-center">
                        <span class="truncate">${escapeHtml(template.name)}</span>
                    </h3>
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${template.language === 'en' ? 'bg-blue-100 text-blue-700' : 'bg-purple-100 text-purple-700'}">
                        <i class="fas ${template.language === 'en' ? 'fa-flag-usa' : 'fa-flag'} mr-1"></i>${template.language.toUpperCase()}
                    </span>
                </div>
                <div class="flex space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onclick="editTemplate('${category}', '${id}')"
                            class="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                            title="Edit template">
                        <i class="fas fa-edit"></i>
                    </button>
                    ${canDelete ? `
                    <button onclick="showDeleteModal('${category}', '${id}')"
                            class="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                            title="Delete template">
                        <i class="fas fa-trash"></i>
                    </button>
                    ` : ''}
                </div>
            </div>
            <p class="text-sm text-gray-600 line-clamp-3 mb-4 leading-relaxed">${escapeHtml(template.body.substring(0, 120))}...</p>
            <div class="flex gap-2">
                <button onclick="setAsDefault('${category}', '${id}', '${template.language}')"
                        class="flex-1 px-4 py-2 ${isDefault ? 'bg-gray-300 text-gray-600 cursor-not-allowed' : 'bg-gradient-to-r from-yellow-400 to-yellow-500 text-white hover:shadow-md'} font-medium rounded-lg transition-all duration-200"
                        ${isDefault ? 'disabled' : ''}>
                    <i class="fas fa-star mr-2"></i>${isDefault ? 'Is Default' : 'Set Default'}
                </button>
                <button onclick="useTemplate('${category}', '${id}')"
                        class="flex-1 px-4 py-2 bg-gradient-to-r ${template.language === 'en' ? 'from-blue-500 to-blue-600' : 'from-purple-500 to-purple-600'} text-white font-medium rounded-lg hover:shadow-md transition-all duration-200">
                    <i class="fas fa-paper-plane mr-2"></i>Use Now
                </button>
            </div>
        </div>
    `;
    }).join('');
}

function showNewTemplateModal() {
    isEditMode = false;
    document.getElementById('templateModal').classList.remove('hidden');
    document.getElementById('templateForm').reset();
    document.getElementById('templateId').value = '';
    document.getElementById('modalTitle').textContent = 'Create New Template';
    selectCategory('application');
    updateCharCount();

    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save Template';
}

function closeTemplateModal() {
    const modal = document.getElementById('templateModal');
    modal.style.opacity = '0';
    setTimeout(() => {
        modal.classList.add('hidden');
        modal.style.opacity = '1';
    }, 200);
}

function selectCategory(category) {
    selectedCategory = category;
    document.getElementById('templateCategory').value = category;

    const appBtn = document.getElementById('categoryApplication');
    const followupBtn = document.getElementById('categoryFollowup');

    appBtn.classList.remove('border-blue-500', 'bg-blue-50', 'shadow-lg');
    followupBtn.classList.remove('border-green-500', 'bg-green-50', 'shadow-lg');

    if (category === 'application') {
        appBtn.classList.add('border-blue-500', 'bg-blue-50', 'shadow-lg');
    } else {
        followupBtn.classList.add('border-green-500', 'bg-green-50', 'shadow-lg');
    }
}

function editTemplate(category, id) {
    isEditMode = true;
    showNewTemplateModal();
    document.getElementById('modalTitle').textContent = 'Edit Template';
    document.getElementById('templateId').value = id;
    selectCategory(category);

    const template = templatesData[category][id];
    document.getElementById('templateName').value = template.name;
    document.getElementById('templateBody').value = template.body;

    if (template.language === 'en') {
        document.getElementById('langEn').checked = true;
    } else {
        document.getElementById('langFr').checked = true;
    }

    updateCharCount();

    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save Template';
}

async function setAsDefault(category, id, language) {
    try {
        Object.keys(templatesData[category]).forEach(templateId => {
            if (templatesData[category][templateId].language === language) {
                templatesData[category][templateId].is_default = false;
            }
        });

        templatesData[category][id].is_default = true;

        const formData = new FormData();
        formData.append('category', category);
        formData.append('name', templatesData[category][id].name);
        formData.append('language', language);
        formData.append('body', templatesData[category][id].body);
        formData.append('is_default', 'true');

        const response = await fetch(`/api/templates/${category}/${id}`, {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            for (const [otherId, template] of Object.entries(templatesData[category])) {
                if (otherId !== id && template.language === language) {
                    const otherFormData = new FormData();
                    otherFormData.append('category', category);
                    otherFormData.append('name', template.name);
                    otherFormData.append('language', template.language);
                    otherFormData.append('body', template.body);
                    otherFormData.append('is_default', 'false');

                    await fetch(`/api/templates/${category}/${otherId}`, {
                        method: 'POST',
                        body: otherFormData
                    });
                }
            }

            renderTemplates();
            showToast(`Template set as default for ${language.toUpperCase()} ${category}s!`, 'success');
        } else {
            showToast('Failed to set default template', 'error');
        }
    } catch (error) {
        showToast('Network error: ' + error.message, 'error');
    }
}

async function submitTemplate() {
    const form = document.getElementById('templateForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const submitBtn = document.getElementById('submitBtn');
    const originalContent = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';

    try {
        const formData = new FormData(form);
        const category = formData.get('category');
        const templateId = formData.get('id');

        const id = templateId || formData.get('name').toLowerCase().replace(/[^a-z0-9]+/g, '_');

        const isDefault = templatesData[category] && templatesData[category][id]
            ? templatesData[category][id].is_default || false
            : false;
        formData.append('is_default', isDefault.toString());

        const response = await fetch(`/api/templates/${category}/${id}`, {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            if (!templatesData[category]) {
                templatesData[category] = {};
            }
            templatesData[category][id] = {
                name: formData.get('name'),
                language: formData.get('language'),
                body: formData.get('body'),
                is_default: isDefault
            };

            submitBtn.disabled = false;
            submitBtn.innerHTML = originalContent;

            closeTemplateModal();
            renderTemplates();

            showToast(isEditMode ? 'Template updated successfully!' : 'Template created successfully!', 'success');
        } else {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalContent;
            showToast('Failed to save template: ' + (data.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalContent;
        showToast('Network error: ' + error.message, 'error');
    }
}

function showDeleteModal(category, id) {
    const template = templatesData[category][id];

    // Set pending delete info
    pendingDelete = { category, id };

    // Update modal content
    document.getElementById('deleteTemplateName').textContent = template.name;

    const langBadge = document.getElementById('deleteTemplateLang');
    if (template.language === 'en') {
        langBadge.className = 'inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-700 mt-1';
        langBadge.innerHTML = '<i class="fas fa-flag-usa mr-1"></i>EN';
    } else {
        langBadge.className = 'inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-purple-100 text-purple-700 mt-1';
        langBadge.innerHTML = '<i class="fas fa-flag mr-1"></i>FR';
    }

    // Reset checkbox and button
    document.getElementById('deleteConfirmCheck').checked = false;
    document.getElementById('deleteConfirmBtn').disabled = true;

    // Show modal
    document.getElementById('deleteModal').classList.remove('hidden');
}

function closeDeleteModal() {
    const modal = document.getElementById('deleteModal');
    modal.style.opacity = '0';
    setTimeout(() => {
        modal.classList.add('hidden');
        modal.style.opacity = '1';
        pendingDelete = { category: null, id: null };
    }, 200);
}

async function confirmDelete() {
    const { category, id } = pendingDelete;

    if (!category || !id) {
        showToast('Delete operation failed: Invalid template', 'error');
        closeDeleteModal();
        return;
    }

    const deleteBtn = document.getElementById('deleteConfirmBtn');
    const originalContent = deleteBtn.innerHTML;
    deleteBtn.disabled = true;
    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Deleting...';

    try {
        const response = await fetch(`/api/templates/${category}/${id}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
            delete templatesData[category][id];

            closeDeleteModal();
            renderTemplates();

            showToast('Template deleted successfully', 'success');
        } else {
            deleteBtn.disabled = false;
            deleteBtn.innerHTML = originalContent;
            showToast('Failed to delete template', 'error');
        }
    } catch (error) {
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = originalContent;
        showToast('Network error: ' + error.message, 'error');
    }
}

function useTemplate(category, id) {
    window.location.href = `/send?template=${category}:${id}`;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Close modals on outside click
document.getElementById('templateModal').addEventListener('click', (e) => {
    if (e.target.id === 'templateModal') {
        closeTemplateModal();
    }
});

document.getElementById('deleteModal').addEventListener('click', (e) => {
    if (e.target.id === 'deleteModal') {
        closeDeleteModal();
    }
});

// Close modals on Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        const templateModal = document.getElementById('templateModal');
        const deleteModal = document.getElementById('deleteModal');

        if (!templateModal.classList.contains('hidden')) {
            closeTemplateModal();
        } else if (!deleteModal.classList.contains('hidden')) {
            closeDeleteModal();
        }
    }
});
</script>

<style>
.line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.category-btn.selected {
    border-width: 2px;
}

/* Smooth modal animation */
.modal {
    animation: fadeIn 0.2s ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

.modal .relative {
    animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
    from {
        transform: translateY(20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

/* Custom scrollbar for modal */
#templateForm::-webkit-scrollbar {
    width: 8px;
}

#templateForm::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

#templateForm::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 10px;
}

#templateForm::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}
</style>
{% endblock %}