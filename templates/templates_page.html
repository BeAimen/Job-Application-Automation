{% extends "base.html" %}
{% block title %}Templates - JobFlow{% endblock %}
{% block nav_templates %}active{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold text-gray-900">Email Templates</h1>
        <p class="text-sm text-gray-500 mt-1">Create and manage your application templates</p>
    </div>
    <button onclick="showNewTemplateModal()" class="btn-primary">
        <i class="fas fa-plus mr-2"></i> New Template
    </button>
</div>

<!-- Template Categories -->
<div class="space-y-6">
    <!-- Application Templates -->
    <div class="bg-white rounded-lg border border-gray-200 shadow-sm">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-paper-plane text-blue-500 mr-2"></i>
                Application Templates
            </h2>
        </div>
        <div class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for id, template in templates.application.items() %}
            <div class="template-card group">
                <div class="flex items-start justify-between mb-3">
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-900">{{ template.name }}</h3>
                        <p class="text-xs text-gray-500 mt-1">
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium {% if template.language == 'en' %}bg-blue-100 text-blue-700{% else %}bg-purple-100 text-purple-700{% endif %}">
                                <i class="fas fa-language mr-1"></i>{{ template.language.upper() }}
                            </span>
                        </p>
                    </div>
                    <div class="flex space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="editTemplate('application', '{{ id }}')" class="text-gray-400 hover:text-blue-600">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteTemplate('application', '{{ id }}')" class="text-gray-400 hover:text-red-600">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <p class="text-sm text-gray-600 line-clamp-3 mb-3">{{ template.body[:120] }}...</p>
                <button onclick="useTemplate('application', '{{ id }}')" class="mt-3 text-sm text-blue-600 hover:text-blue-700 font-medium">
                    Use Template →
                </button>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Follow-up Templates -->
    <div class="bg-white rounded-lg border border-gray-200 shadow-sm">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-redo text-green-500 mr-2"></i>
                Follow-up Templates
            </h2>
        </div>
        <div class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for id, template in templates.followup.items() %}
            <div class="template-card group">
                <div class="flex items-start justify-between mb-3">
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-900">{{ template.name }}</h3>
                        <p class="text-xs text-gray-500 mt-1">
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium {% if template.language == 'en' %}bg-blue-100 text-blue-700{% else %}bg-purple-100 text-purple-700{% endif %}">
                                <i class="fas fa-language mr-1"></i>{{ template.language.upper() }}
                            </span>
                        </p>
                    </div>
                    <div class="flex space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="editTemplate('followup', '{{ id }}')" class="text-gray-400 hover:text-blue-600">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteTemplate('followup', '{{ id }}')" class="text-gray-400 hover:text-red-600">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <p class="text-sm text-gray-600 line-clamp-3 mb-3">{{ template.body[:120] }}...</p>
                <button onclick="useTemplate('followup', '{{ id }}')" class="mt-3 text-sm text-blue-600 hover:text-blue-700 font-medium">
                    Use Template →
                </button>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Template Editor Modal -->
<div id="templateModal" class="modal hidden">
    <div class="modal-content modal-content-large">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-900">
                <span id="modalTitle">Create New Template</span>
            </h3>
            <button onclick="closeTemplateModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <form id="templateForm" class="space-y-5">
            <input type="hidden" id="templateCategory" name="category">
            <input type="hidden" id="templateId" name="id">

            <!-- Category Selection -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Template Type</label>
                <div class="grid grid-cols-2 gap-3">
                    <button type="button" onclick="selectCategory('application')"
                            id="categoryApplication"
                            class="category-btn flex items-center justify-center p-4 border-2 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all">
                        <i class="fas fa-paper-plane text-2xl text-blue-500 mr-3"></i>
                        <span class="font-medium">Application</span>
                    </button>
                    <button type="button" onclick="selectCategory('followup')"
                            id="categoryFollowup"
                            class="category-btn flex items-center justify-center p-4 border-2 rounded-lg hover:border-green-500 hover:bg-green-50 transition-all">
                        <i class="fas fa-redo text-2xl text-green-500 mr-3"></i>
                        <span class="font-medium">Follow-up</span>
                    </button>
                </div>
            </div>

            <!-- Template Name -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Template Name</label>
                <input type="text" id="templateName" name="name" required
                       placeholder="e.g., Professional Application - Tech Industry"
                       class="form-input">
            </div>

            <!-- Language -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Language</label>
                <div class="grid grid-cols-2 gap-3">
                    <label class="flex items-center p-3 border-2 rounded-lg cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-all">
                        <input type="radio" name="language" value="en" id="langEn" required class="mr-3">
                        <i class="fas fa-flag-usa text-blue-500 mr-2"></i>
                        <span class="font-medium">English</span>
                    </label>
                    <label class="flex items-center p-3 border-2 rounded-lg cursor-pointer hover:border-purple-500 hover:bg-purple-50 transition-all">
                        <input type="radio" name="language" value="fr" id="langFr" required class="mr-3">
                        <i class="fas fa-flag text-purple-500 mr-2"></i>
                        <span class="font-medium">French</span>
                    </label>
                </div>
            </div>

            <!-- Email Body -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email Body</label>
                <textarea id="templateBody" name="body" rows="12" required
                          placeholder="Dear Hiring Manager,&#10;&#10;I am writing to express my interest in the [Position] position at [Company]...&#10;&#10;You can use placeholders:&#10;- [Company] for company name&#10;- [Position] for position title"
                          class="form-input"></textarea>
                <p class="mt-2 text-sm text-gray-500">
                    <i class="fas fa-info-circle text-blue-500"></i>
                    Use placeholders: <code class="bg-gray-100 px-2 py-1 rounded">[Company]</code> and <code class="bg-gray-100 px-2 py-1 rounded">[Position]</code>
                </p>
            </div>

            <!-- Submit Buttons -->
            <div class="flex justify-end space-x-3 pt-4 border-t">
                <button type="button" onclick="closeTemplateModal()" class="btn-secondary">Cancel</button>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-save mr-2"></i> Save Template
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let selectedCategory = 'application';

function showNewTemplateModal() {
    document.getElementById('templateModal').classList.remove('hidden');
    document.getElementById('templateForm').reset();
    document.getElementById('templateId').value = '';
    document.getElementById('modalTitle').textContent = 'Create New Template';
    selectCategory('application');
}

function closeTemplateModal() {
    document.getElementById('templateModal').classList.add('hidden');
}

function selectCategory(category) {
    selectedCategory = category;
    document.getElementById('templateCategory').value = category;

    // Update button styles
    const appBtn = document.getElementById('categoryApplication');
    const followupBtn = document.getElementById('categoryFollowup');

    if (category === 'application') {
        appBtn.classList.add('border-blue-500', 'bg-blue-50');
        followupBtn.classList.remove('border-green-500', 'bg-green-50');
    } else {
        followupBtn.classList.add('border-green-500', 'bg-green-50');
        appBtn.classList.remove('border-blue-500', 'bg-blue-50');
    }
}

async function editTemplate(category, id) {
    showNewTemplateModal();
    document.getElementById('modalTitle').textContent = 'Edit Template';
    document.getElementById('templateId').value = id;
    selectCategory(category);

    // Load template data
    const templates = {{ templates | tojson }};
    const template = templates[category][id];

    document.getElementById('templateName').value = template.name;
    document.getElementById('templateBody').value = template.body;

    if (template.language === 'en') {
        document.getElementById('langEn').checked = true;
    } else {
        document.getElementById('langFr').checked = true;
    }
}

async function deleteTemplate(category, id) {
    if (confirm('Are you sure you want to delete this template?')) {
        try {
            const response = await fetch(`/api/templates/${category}/${id}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (data.success) {
                showToast('Template deleted successfully', 'success');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showToast('Failed to delete template', 'error');
            }
        } catch (error) {
            showToast('Network error: ' + error.message, 'error');
        }
    }
}

function useTemplate(category, id) {
    window.location.href = `/send?template=${category}:${id}`;
}

// Form submission
document.getElementById('templateForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(e.target);
    const submitButton = e.target.querySelector('button[type="submit"]');

    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';

    try {
        const response = await fetch('/api/templates', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            showToast('Template saved successfully!', 'success');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showToast('Failed to save template: ' + data.error, 'error');
        }
    } catch (error) {
        showToast('Network error: ' + error.message, 'error');
    } finally {
        submitButton.disabled = false;
        submitButton.innerHTML = '<i class="fas fa-save mr-2"></i> Save Template';
    }
});

// Close modal on outside click
document.getElementById('templateModal').addEventListener('click', (e) => {
    if (e.target.id === 'templateModal') {
        closeTemplateModal();
    }
});
</script>

<style>
.category-btn.selected {
    border-width: 2px;
}

.modal-content {
    max-height: 90vh;
    overflow-y: auto;
}

.line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>
{% endblock %}