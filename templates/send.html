{% extends "base.html" %}
{% block title %}Send Application - JobFlow{% endblock %}
{% block nav_send %}active{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">Send Application</h1>

    <div class="bg-white shadow-lg rounded-2xl p-6 max-w-5xl mx-auto relative overflow-hidden">
        <form id="sendForm" class="space-y-8" novalidate>

            <!-- Smart Intake -->
            <section aria-labelledby="intakeHeading" class="space-y-4">
                <div class="flex items-center justify-between">
                    <h2 id="intakeHeading" class="text-lg font-semibold text-gray-900">Smart Intake</h2>
                    <div class="text-sm text-gray-600" id="recipientSummary">Will send 0 emails</div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-[2fr,1fr] gap-4 items-start">
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">Recipients <span class="text-red-500">*</span></label>
                        <textarea
                            id="emailsInput"
                            name="emails"
                            rows="3"
                            required
                            aria-required="true"
                            placeholder="hr@company.com&#10;talent@company.com"
                            class="form-input border-2 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all w-full resize-y"
                        >{{ prefill_email or '' }}</textarea>
                        <div class="flex items-center text-xs text-gray-600 space-x-3" id="emailCounters">
                            <span><i class="fas fa-check text-green-500 mr-1"></i><span id="validCount">0</span> valid</span>
                            <span><i class="fas fa-exclamation-triangle text-yellow-500 mr-1"></i><span id="duplicateCount">0</span> duplicates removed</span>
                            <span><i class="fas fa-times text-red-500 mr-1"></i><span id="invalidCount">0</span> invalid</span>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">Company (optional)</label>
                        <div class="flex items-center space-x-2">
                            <input
                                type="text"
                                name="company"
                                id="companyInput"
                                list="companySuggestions"
                                placeholder="Search or type a company"
                                value="{{ prefill_company or '' }}"
                                class="form-input w-full"
                            />
                            <button type="button" id="applyCompanyBtn" class="btn-secondary whitespace-nowrap">
                                <i class="fas fa-magic mr-1"></i> Apply details
                            </button>
                        </div>
                        <datalist id="companySuggestions">
                            {% for c in companies %}
                            <option value="{{ c.name }}"></option>
                            {% endfor %}
                        </datalist>
                        <p class="text-xs text-gray-500" id="companyStatus">Selecting is optional. Apply to prefill details.</p>
                    </div>
                </div>
            </section>

            <!-- Language Mode -->
            <section aria-labelledby="languageHeading" class="space-y-3">
                <h2 id="languageHeading" class="text-lg font-semibold text-gray-900">Language Mode</h2>
                <fieldset class="grid grid-cols-1 md:grid-cols-3 gap-3" role="radiogroup" aria-label="Language selection">
                    <label class="cursor-pointer block">
                        <input type="radio" name="language" value="en"
                               {% if default_language == 'en' %}checked{% endif %}
                               onchange="handleLanguageChange(this.value)"
                               class="peer sr-only">
                        <div class="p-4 border-2 rounded-lg transition-all peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:border-blue-300 space-y-2">
                            <div class="flex items-center justify-between">
                                <span class="font-semibold text-gray-900">English</span>
                                <span class="text-xs text-gray-500">1 email</span>
                            </div>
                            <p class="text-xs text-gray-600">Uses English body and CV.</p>
                        </div>
                    </label>

                    <label class="cursor-pointer block">
                        <input type="radio" name="language" value="fr"
                               {% if default_language == 'fr' %}checked{% endif %}
                               onchange="handleLanguageChange(this.value)"
                               class="peer sr-only">
                        <div class="p-4 border-2 rounded-lg transition-all peer-checked:border-purple-500 peer-checked:bg-purple-50 hover:border-purple-300 space-y-2">
                            <div class="flex items-center justify-between">
                                <span class="font-semibold text-gray-900">French</span>
                                <span class="text-xs text-gray-500">1 email</span>
                            </div>
                            <p class="text-xs text-gray-600">Uses French body and CV.</p>
                        </div>
                    </label>

                    <label class="cursor-pointer block">
                        <input type="radio" name="language" value="both"
                               {% if default_language == 'both' %}checked{% endif %}
                               onchange="handleLanguageChange(this.value)"
                               class="peer sr-only">
                        <div class="p-4 border-2 rounded-lg transition-all peer-checked:border-gray-500 peer-checked:bg-gray-50 hover:border-gray-300 space-y-2">
                            <div class="flex items-center justify-between">
                                <span class="font-semibold text-gray-900">Both</span>
                                <span class="text-xs text-gray-500">2 emails</span>
                            </div>
                            <p class="text-xs text-gray-600">Sends EN + FR with their own CVs.</p>
                        </div>
                    </label>
                </fieldset>
            </section>

            <!-- Adaptive Composer -->
            <section aria-labelledby="composerHeading" class="space-y-4">
                <div class="flex items-center justify-between">
                    <h2 id="composerHeading" class="text-lg font-semibold text-gray-900">Compose</h2>
                    <div id="readinessStrip" class="text-xs text-gray-600"></div>
                </div>

                <!-- Tab controls for dual language -->
                <div id="languageTabs" class="hidden border-b border-gray-200 mb-2">
                    <nav class="-mb-px flex space-x-4" aria-label="Language tabs">
                        <button type="button" class="lang-tab active" data-lang="en">English</button>
                        <button type="button" class="lang-tab" data-lang="fr">French</button>
                    </nav>
                </div>

                <!-- Single composer -->
                <div id="composerSingle" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-[1.2fr,0.8fr] gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Position</label>
                            <input
                                type="text"
                                name="position"
                                id="positionSingleInput"
                                value="{{ prefill_position or default_position_en }}"
                                placeholder="Software Engineer, Data Analyst..."
                                class="form-input w-full"
                            />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Attachment (CV)</label>
                            <select name="attachment" required class="form-input w-full" id="attachmentSelect" aria-required="true">
                                {% for att in attachments_en %}
                                <option value="{{ att }}"
                                    {% if prefill_attachment and att == prefill_attachment %}selected
                                    {% elif not prefill_attachment and loop.first %}selected{% endif %}
                                >{{ att }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email Body</label>
                        <textarea
                            name="body"
                            id="bodySingleInput"
                            rows="8"
                            class="form-input w-full"
                        >{{ prefill_body or default_body_en }}</textarea>
                        <p class="mt-1 text-xs text-gray-500">Placeholders: <code class="bg-gray-100 px-2 py-1 rounded">[Company]</code>, <code class="bg-gray-100 px-2 py-1 rounded">[Position]</code></p>
                    </div>
                </div>

                <!-- Dual composer -->
                <div id="composerDual" class="hidden">
                    <div class="language-pane" data-lang-pane="en">
                        <div class="grid grid-cols-1 md:grid-cols-[1.2fr,0.8fr] gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Position (EN)</label>
                                <input
                                    type="text"
                                    name="position_en"
                                    id="positionEnInput"
                                    value="{{ prefill_position_en or default_position_en }}"
                                    class="form-input w-full"
                                />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Attachment (EN)</label>
                                <select name="attachment_en" required class="form-input w-full" id="attachmentEnSelect">
                                    {% for att in attachments_en %}
                                    <option value="{{ att }}"
                                        {% if prefill_attachment_en and att == prefill_attachment_en %}selected
                                        {% elif not prefill_attachment_en and loop.first %}selected{% endif %}
                                    >{{ att }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email Body (EN)</label>
                            <textarea
                                name="body_en"
                                id="bodyEnInput"
                                rows="8"
                                class="form-input w-full"
                            >{{ prefill_body_en or default_body_en }}</textarea>
                        </div>
                    </div>

                    <div class="language-pane hidden" data-lang-pane="fr">
                        <div class="grid grid-cols-1 md:grid-cols-[1.2fr,0.8fr] gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Position (FR)</label>
                                <input
                                    type="text"
                                    name="position_fr"
                                    id="positionFrInput"
                                    value="{{ prefill_position_fr or default_position_fr }}"
                                    class="form-input w-full"
                                />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Attachment (FR)</label>
                                <select name="attachment_fr" required class="form-input w-full" id="attachmentFrSelect">
                                    {% for att in attachments_fr %}
                                    <option value="{{ att }}"
                                        {% if prefill_attachment_fr and att == prefill_attachment_fr %}selected
                                        {% elif not prefill_attachment_fr and loop.first %}selected{% endif %}
                                    >{{ att }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email Body (FR)</label>
                            <textarea
                                name="body_fr"
                                id="bodyFrInput"
                                rows="8"
                                class="form-input w-full"
                            >{{ prefill_body_fr or default_body_fr }}</textarea>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Details Drawer -->
            <section aria-labelledby="detailsHeading">
                <div class="flex items-center justify-between">
                    <h2 id="detailsHeading" class="text-lg font-semibold text-gray-900">Details</h2>
                    <button type="button" onclick="toggleDetails()" id="detailsToggle" class="text-sm text-blue-600 hover:text-blue-700">
                        <i class="fas fa-chevron-down mr-1"></i>Show details
                    </button>
                </div>
                <div id="detailsDrawer" class="hidden mt-4 space-y-6 border border-gray-200 rounded-xl p-4 bg-gray-50" aria-hidden="true">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Company Type</label>
                            <select name="company_type" id="companyTypeSelect" class="form-input w-full">
                                <option value="">Select</option>
                                <option value="Oil & Gas" {% if prefill_company_type == 'Oil & Gas' %}selected{% endif %}>Oil & Gas</option>
                                <option value="Petrochemical" {% if prefill_company_type == 'Petrochemical' %}selected{% endif %}>Petrochemical</option>
                                <option value="Power & Energy" {% if prefill_company_type == 'Power & Energy' %}selected{% endif %}>Power & Energy</option>
                                <option value="Manufacturing / Industrial Plants" {% if prefill_company_type == 'Manufacturing / Industrial Plants' %}selected{% endif %}>Manufacturing / Industrial Plants</option>
                                <option value="Food Processing / Food Industry" {% if prefill_company_type == 'Food Processing / Food Industry' %}selected{% endif %}>Food Processing / Food Industry</option>
                                <option value="Consumer Goods" {% if prefill_company_type == 'Consumer Goods' %}selected{% endif %}>Consumer Goods</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Website</label>
                            <input type="url" name="website" id="websiteInput" placeholder="https://company.com" value="{{ prefill_website or '' }}" class="form-input w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                            <input type="tel" name="phone" id="phoneInput" placeholder="+1 234 567 890" value="{{ prefill_phone or '' }}" class="form-input w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Location / Place</label>
                            <input type="text" name="place" id="placeInput" placeholder="City, Country" value="{{ prefill_place or '' }}" class="form-input w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Reference / Source</label>
                            <input type="text" name="reference" id="referenceInput" placeholder="Job reference, requisition ID, or source" value="{{ prefill_reference or '' }}" class="form-input w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Salary Range</label>
                            <input type="text" name="salary" id="salaryInput" placeholder="e.g. 80,000 – 120,000" value="{{ prefill_salary or '' }}" class="form-input w-full">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Internal Notes</label>
                        <textarea name="notes" id="notesInput" rows="3" class="form-input w-full" placeholder="Interview notes, recruiter name, internal remarks...">{{ prefill_notes or '' }}</textarea>
                    </div>
                </div>
            </section>

            <!-- Sticky Send Bar -->
            <div class="sticky bottom-0 left-0 right-0 bg-white pt-4 border-t border-gray-200">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-3 md:space-y-0">
                    <div id="preflightStatus" class="text-sm text-gray-700">
                        Ready to send
                    </div>
                    <div class="flex items-center space-x-3">
                        <button type="reset" class="btn-secondary" id="resetBtn">
                            <i class="fas fa-undo mr-1"></i> Reset
                        </button>
                        <button type="submit" class="btn-primary" id="sendBtn">
                            <i class="fas fa-paper-plane mr-1"></i> Send Application
                        </button>
                    </div>
                </div>
            </div>
        </form>

        <!-- Delivery Report -->
        <div id="deliveryReport" class="hidden mt-6 border border-gray-200 rounded-xl p-4 bg-gray-50" aria-live="polite">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-semibold text-gray-900">Delivery Report</h3>
                <span id="deliverySummary" class="text-sm font-medium text-gray-700"></span>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-2 text-left text-gray-600">Recipient</th>
                            <th class="px-4 py-2 text-left text-gray-600">Language</th>
                            <th class="px-4 py-2 text-left text-gray-600">Status</th>
                            <th class="px-4 py-2 text-left text-gray-600">Attachment</th>
                            <th class="px-4 py-2 text-left text-gray-600">Timestamp</th>
                        </tr>
                    </thead>
                    <tbody id="deliveryRows" class="divide-y divide-gray-200 bg-white"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
const attachmentsData = {
    en: {{ attachments_en | tojson }},
    fr: {{ attachments_fr | tojson }}
};

const companiesData = {{ companies | tojson }};

// Fallback toast handler to avoid runtime errors if main.js fails to load
if (typeof showToast !== 'function') {
    function showToast(message, type = 'info') {
        const friendly = `[${type.toUpperCase()}] ${message}`;
        console.log(friendly);
        alert(friendly);
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    const defaultLanguage = '{{ default_language }}';

    // Set the default language radio button
    const radioButton = document.querySelector(`input[name="language"][value="${defaultLanguage}"]`);
    if (radioButton) {
        radioButton.checked = true;
    }

    // Trigger the change to update the UI
    handleLanguageChange(defaultLanguage);

    setupCompanyApply();
    setupEmailWatcher();
    setupTabs();
});

function handleLanguageChange(language) {
    const composerSingle = document.getElementById('composerSingle');
    const composerDual = document.getElementById('composerDual');
    const languageTabs = document.getElementById('languageTabs');

    if (language === 'both') {
        composerSingle.classList.add('hidden');
        composerDual.classList.remove('hidden');
        languageTabs.classList.remove('hidden');
        document.getElementById('attachmentSelect').removeAttribute('required');
        document.getElementById('attachmentEnSelect').setAttribute('required', 'required');
        document.getElementById('attachmentFrSelect').setAttribute('required', 'required');
        switchLanguageTab('en');
    } else {
        composerSingle.classList.remove('hidden');
        composerDual.classList.add('hidden');
        languageTabs.classList.add('hidden');
        document.getElementById('attachmentSelect').setAttribute('required', 'required');
        document.getElementById('attachmentEnSelect').removeAttribute('required');
        document.getElementById('attachmentFrSelect').removeAttribute('required');
    }

    refreshReadiness();
    updatePreflight();
}

function updateAttachmentSelect(language, selectId) {
    const select = document.getElementById(selectId);
    const attachments = attachmentsData[language];
    select.innerHTML = '';

    attachments.forEach((att, index) => {
        const option = document.createElement('option');
        option.value = att;
        option.textContent = att;
        if (index === 0) option.selected = true;
        select.appendChild(option);
    });
}

function handleCompanySelection(name) {
    const company = findCompanyByName(name);
    if (company) {
        applyCompanyDetails(company, true);
    }
}

function findCompanyByName(name) {
    if (!name) return null;
    return companiesData.find(c => (c.name || '').toLowerCase() === name.trim().toLowerCase()) || null;
}

function applyCompanyDetails(company, markApplied = false) {
    if (!company) return;
    showDetailsDrawer(true);

    const emailField = document.getElementById('emailsInput');
    const formattedEmails = (company.email || '')
        .split(',')
        .map(e => e.trim())
        .filter(Boolean)
        .join('\n');

    if (emailField && formattedEmails) {
        emailField.value = formattedEmails;
    }

    setFieldValue(document.getElementById('companyTypeSelect'), company.type);
    setFieldValue(document.getElementById('websiteInput'), company.website);
    setFieldValue(document.getElementById('phoneInput'), company.phone);
    setFieldValue(document.getElementById('placeInput'), company.location);
    setFieldValue(document.getElementById('referenceInput'), company.reference);
    setFieldValue(document.getElementById('salaryInput'), company.salary_range);
    setFieldValue(document.getElementById('notesInput'), company.notes);

    if (markApplied) {
        document.getElementById('companyStatus').textContent = 'Details populated from ' + company.name;
        document.getElementById('companyStatus').classList.add('text-green-700');
    }
}

function setFieldValue(element, value) {
    if (!element || !value) return;
    element.value = value;
}

function showDetailsDrawer(forceOpen = false) {
    const drawer = document.getElementById('detailsDrawer');
    const toggle = document.getElementById('detailsToggle');
    if (forceOpen) {
        drawer.classList.remove('hidden');
        drawer.setAttribute('aria-hidden', 'false');
        toggle.innerHTML = '<i class="fas fa-chevron-up mr-1"></i>Hide details';
        return;
    }
    const expanded = !drawer.classList.contains('hidden');
    drawer.classList.toggle('hidden');
    drawer.setAttribute('aria-hidden', String(expanded));
    toggle.innerHTML = expanded
        ? '<i class="fas fa-chevron-down mr-1"></i>Show details'
        : '<i class="fas fa-chevron-up mr-1"></i>Hide details';
}

function toggleDetails() {
    showDetailsDrawer();
}

function setupCompanyApply() {
    const companyInput = document.getElementById('companyInput');
    const applyBtn = document.getElementById('applyCompanyBtn');
    if (!companyInput || !applyBtn) return;

    applyBtn.addEventListener('click', () => {
        const company = findCompanyByName(companyInput.value);
        applyCompanyDetails(company, true);
    });
}

function setupEmailWatcher() {
    const emailsInput = document.getElementById('emailsInput');
    if (!emailsInput) return;
    const update = () => {
        const { valid, invalid, duplicatesRemoved } = parseEmails(emailsInput.value);
        document.getElementById('validCount').textContent = valid.length;
        document.getElementById('invalidCount').textContent = invalid.length;
        document.getElementById('duplicateCount').textContent = duplicatesRemoved;
        document.getElementById('recipientSummary').textContent = `Will send ${valid.length} emails`;
        updatePreflight();
    };
    emailsInput.addEventListener('input', update);
    update();
}

function parseEmails(raw) {
    const entries = raw.replace(/\n/g, ',').split(',').map(e => e.trim()).filter(Boolean);
    const seen = new Set();
    const valid = [];
    const invalid = [];
    let duplicatesRemoved = 0;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    for (const e of entries) {
        if (!emailRegex.test(e)) {
            invalid.push(e);
            continue;
        }
        if (seen.has(e.toLowerCase())) {
            duplicatesRemoved += 1;
            continue;
        }
        seen.add(e.toLowerCase());
        valid.push(e);
    }
    return { valid, invalid, duplicatesRemoved };
}

function setupTabs() {
    document.querySelectorAll('.lang-tab').forEach(btn => {
        btn.addEventListener('click', () => switchLanguageTab(btn.dataset.lang));
    });
}

function switchLanguageTab(lang) {
    document.querySelectorAll('.lang-tab').forEach(btn => {
        if (btn.dataset.lang === lang) {
            btn.classList.add('border-b-2', 'border-blue-500', 'text-blue-700', 'active');
        } else {
            btn.classList.remove('border-b-2', 'border-blue-500', 'text-blue-700', 'active');
        }
    });
    document.querySelectorAll('.language-pane').forEach(pane => {
        pane.classList.toggle('hidden', pane.dataset.langPane !== lang);
    });
    refreshReadiness();
}

function getReadiness() {
    const language = document.querySelector('input[name="language"]:checked').value;
    const { valid } = parseEmails(document.getElementById('emailsInput').value);
    const issues = [];

    if (valid.length === 0) issues.push('Add at least one valid recipient');

    if (language === 'both') {
        if (!document.getElementById('attachmentEnSelect').value) issues.push('Attach CV for English');
        if (!document.getElementById('attachmentFrSelect').value) issues.push('Attach CV for French');
        if (!document.getElementById('bodyEnInput').value.trim()) issues.push('Add English body');
        if (!document.getElementById('bodyFrInput').value.trim()) issues.push('Add French body');
    } else {
        if (!document.getElementById('attachmentSelect').value) issues.push('Attach CV');
        if (!document.getElementById('bodySingleInput').value.trim()) issues.push('Add email body');
    }

    return { issues, language, recipientCount: valid.length };
}

function refreshReadiness() {
    const readinessStrip = document.getElementById('readinessStrip');
    const { language } = getReadiness();
    if (language === 'both') {
        const enOk = document.getElementById('attachmentEnSelect').value && document.getElementById('bodyEnInput').value.trim();
        const frOk = document.getElementById('attachmentFrSelect').value && document.getElementById('bodyFrInput').value.trim();
        readinessStrip.textContent = `EN: ${enOk ? 'Ready' : 'Missing fields'} | FR: ${frOk ? 'Ready' : 'Missing fields'}`;
    } else {
        const singleOk = document.getElementById('attachmentSelect').value && document.getElementById('bodySingleInput').value.trim();
        readinessStrip.textContent = singleOk ? 'Ready' : 'Add attachment and body';
    }
}

function updatePreflight() {
    const { issues, recipientCount } = getReadiness();
    const preflight = document.getElementById('preflightStatus');
    if (issues.length === 0) {
        preflight.textContent = `Ready to send (${recipientCount} recipients)`;
        preflight.classList.remove('text-red-600');
    } else {
        preflight.textContent = `${issues.length} issues to resolve: ${issues.join(', ')}`;
        preflight.classList.add('text-red-600');
    }
}

// Form submission
document.getElementById('sendForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const { issues } = getReadiness();
    if (issues.length) {
        showToast('Please resolve: ' + issues.join('; '), 'warning');
        return;
    }

    const formData = new FormData(e.target);
    const language = document.querySelector('input[name="language"]:checked').value;
    formData.set('language', language);

    const submitButton = document.getElementById('sendBtn');
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Sending...';

    try {
        const response = await fetch('/send', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (response.ok) {
            renderDeliveryReport(data.results);
            showToast('Applications sent successfully!', 'success');
        } else {
            renderDeliveryReport([]);
            showToast(data.detail || 'Failed to send applications', 'error');
        }
    } catch (error) {
        renderDeliveryReport([]);
        showToast('Network error: ' + error.message, 'error');
    } finally {
        submitButton.disabled = false;
        submitButton.innerHTML = '<i class="fas fa-paper-plane mr-1"></i> Send Application';
    }
});

function renderDeliveryReport(results) {
    const report = document.getElementById('deliveryReport');
    const summaryEl = document.getElementById('deliverySummary');
    const rowsEl = document.getElementById('deliveryRows');

    if (!results || results.length === 0) {
        report.classList.add('hidden');
        return;
    }

    report.classList.remove('hidden');
    const successCount = results.filter(r => r.status === 'success').length;
    const failCount = results.length - successCount;
    summaryEl.textContent = `Sent ${successCount}/${results.length} • ${failCount} failed`;

    rowsEl.innerHTML = results.map(r => {
        const color = r.status === 'success' ? 'text-green-700' : 'text-red-700';
        const attachment = r.attachment || '';
        return `
            <tr>
                <td class="px-4 py-2 text-gray-900">${r.email || ''}</td>
                <td class="px-4 py-2 text-gray-700 uppercase">${(r.language || '').toUpperCase()}</td>
                <td class="px-4 py-2 ${color} font-medium">${r.status}</td>
                <td class="px-4 py-2 text-gray-700">${attachment}</td>
                <td class="px-4 py-2 text-gray-500">${new Date().toISOString().slice(0,16).replace('T',' ')}</td>
            </tr>
        `;
    }).join('');

    report.scrollIntoView({ behavior: 'smooth' });
}
</script>
{% endblock %}
